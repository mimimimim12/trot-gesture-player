<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>âœ¨ íŠ¸ë¡œíŠ¸ ì œìŠ¤ì²˜ í”Œë ˆì´ì–´</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
  
  <style>
    /* ìŠ¤íƒ€ì¼ì€ ê·¸ëŒ€ë¡œ ìœ ì§€ */
    :root {
      --bg-color: #1a1a1a;
      --card-color: #2c2c2c;
      --text-color: #f0f0f0;
      --primary-color: #00e091;
      --font-family: 'Noto Sans KR', sans-serif;
    }
    body {
      background-color: var(--bg-color);
      color: var(--text-color);
      font-family: var(--font-family);
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      margin: 0;
      padding: 20px;
      box-sizing: border-box;
    }
    .main-container {
      display: flex;
      flex-wrap: wrap;
      gap: 30px;
      justify-content: center;
      align-items: flex-start;
      max-width: 1000px;
    }
    .player-column, .guide-column {
      background-color: var(--card-color);
      padding: 30px;
      border-radius: 16px;
      box-shadow: 0 8px 30px rgba(0, 0, 0, 0.2);
      text-align: center;
    }
    .player-column { flex: 2; min-width: 540px; }
    .guide-column { flex: 1; min-width: 300px; }
    h1 {
      margin-top: 0;
      font-weight: 700;
      color: var(--primary-color);
    }
    p { color: #aaa; margin-bottom: 25px; }
    #container {
      position: relative;
      display: inline-block;
      margin-top: 20px;
      border-radius: 8px;
      overflow: hidden;
    }
    #video, #canvas { border-radius: 8px; }
    #canvas { position: absolute; left: 0; top: 0; pointer-events: none; }
    #status {
      margin-top: 15px;
      font-size: 1.1em;
      font-weight: bold;
      height: 2em;
      line-height: 2em;
      color: #fff;
    }
    audio { 
      margin-top: 10px; 
      width: 100%;
      color-scheme: dark;
    }
    #fileInput { display: none; }
    .file-label {
      background-color: var(--primary-color);
      color: #111;
      padding: 12px 25px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      display: inline-block;
      transition: background-color 0.3s;
    }
    .file-label:hover { background-color: #00c781; }
    #fileName {
      margin-left: 15px;
      color: #ccc;
      font-size: 0.9em;
    }
    .guide-column h2, .guide-column h3 {
      margin-top: 0;
      margin-bottom: 20px;
      border-bottom: 2px solid var(--primary-color);
      padding-bottom: 10px;
    }
    .guide-column h3 {
      border-bottom: none;
      padding-bottom: 0;
      margin-bottom: 10px;
    }
    .gesture-list {
      list-style: none;
      padding: 0;
      text-align: left;
    }
    .gesture-list li {
      display: flex;
      align-items: center;
      margin-bottom: 20px;
      font-size: 1.1em;
    }
    .gesture-icon {
      font-size: 2.2em;
      margin-right: 20px;
      width: 50px;
      text-align: center;
    }
    #loader {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.7);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 10;
    }
    .spinner {
      width: 60px;
      height: 60px;
      border: 5px solid #555;
      border-top-color: var(--primary-color);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body>

<div class="main-container">
  <div class="player-column">
    <h1>âœ¨ íŠ¸ë¡œíŠ¸ ì œìŠ¤ì²˜ í”Œë ˆì´ì–´</h1>
    <p>ì•„ë˜ ë²„íŠ¼ìœ¼ë¡œ ìŒì•… íŒŒì¼ì„ ì„ íƒí•˜ë©´ ì›¹ìº ì´ ì‹œì‘ë©ë‹ˆë‹¤.</p>
    
    <div>
      <label for="fileInput" class="file-label">ìŒì•… íŒŒì¼ ì„ íƒ</label>
      <span id="fileName">ì„ íƒëœ íŒŒì¼ ì—†ìŒ</span>
    </div>
    <input type="file" id="fileInput" accept=".mp3,.wav" />

    <div id="container">
      <div id="loader">
        <div class="spinner"></div>
      </div>
      <video id="video" width="480" height="360" autoplay muted playsinline></video>
      <canvas id="canvas" width="480" height="360"></canvas>
    </div>
    <div id="status">ìŒì•… íŒŒì¼ì„ ì„ íƒí•´ ì£¼ì„¸ìš”.</div>
    <audio id="audio" controls></audio>
  </div>

  <div class="guide-column">
    <h2>ğŸµ ì œìŠ¤ì²˜ ì•ˆë‚´</h2>

    <h3>ğŸ¬ ì‹¤í–‰ ì˜ˆì‹œ ì˜ìƒ</h3>
    <video src="assets/sample.mp4" width="300" controls muted loop playsinline style="border-radius: 8px; margin-bottom: 20px;"></video>
    
    <ul class="gesture-list">
      <li><span class="gesture-icon">âœŠ</span> <div><strong>ì£¼ë¨¹:</strong> ìŒì•… ì¬ìƒ / ì¼ì‹œì •ì§€</div></li>
      <li><span class="gesture-icon">ğŸ–ï¸</span> <div><strong>ì†ë°”ë‹¥:</strong> 1.5ë°°ì†ìœ¼ë¡œ ì¬ìƒ</div></li>
      <li><span class="gesture-icon">ğŸ‘</span> <div><strong>ì—„ì§€ì²™:</strong> 2.0ë°°ì†ìœ¼ë¡œ ì¬ìƒ</div></li>
      <li><span class="gesture-icon">ğŸ¤™</span> <div><strong>ìƒˆë¼ì†ê°€ë½:</strong> 1.0ë°°ì†(ê¸°ë³¸)ìœ¼ë¡œ ì¬ìƒ</div></li>
    </ul>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>

<script>
const videoElement = document.getElementById('video');
const canvasElement = document.getElementById('canvas');
const canvasCtx = canvasElement.getContext('2d');
const audioElement = document.getElementById('audio');
const statusDiv = document.getElementById('status');
const fileInput = document.getElementById('fileInput');
const fileNameSpan = document.getElementById('fileName');
const loader = document.getElementById('loader');

let lastGestureTime = 0;
let currentSpeed = 1.0;
let isCameraStarted = false;

const worker = new Worker('worker.js');

worker.onmessage = async (e) => {
  const { type, data, error } = e.data;

  if (type === 'conversion-start') {
    loader.style.display = 'flex';
    statusDiv.textContent = "mp3 ë³€í™˜ ì¤‘... (í™”ë©´ì€ ë©ˆì¶”ì§€ ì•Šì•„ìš”!)";
  } else if (type === 'conversion-complete') {
    try {
      const wavBuffer = new Uint8Array(data);
      const wavBlob = new Blob([wavBuffer], { type: 'audio/wav' });
      audioElement.src = URL.createObjectURL(wavBlob);

      statusDiv.textContent = "mp3 â†’ wav ë³€í™˜ ì™„ë£Œ! ì¬ìƒí•©ë‹ˆë‹¤.";
      loader.style.display = 'none';

      if (audioElement.paused) {
        await audioElement.play().catch(err => {
          console.warn("ìë™ ì¬ìƒ ì‹¤íŒ¨:", err);
        });
      }
    } catch (err) {
      statusDiv.textContent = `ì˜¤ë””ì˜¤ ì²˜ë¦¬ ì˜¤ë¥˜: ${err.message}`;
    }
  } else if (type === 'conversion-error') {
    statusDiv.textContent = `ë³€í™˜ ì˜¤ë¥˜: ${error}`;
    loader.style.display = 'none';
  }
};

fileInput.addEventListener('change', async (e) => {
  const file = e.target.files[0];
  if (!file) {
    fileNameSpan.textContent = "ì„ íƒëœ íŒŒì¼ ì—†ìŒ";
    return;
  }
  fileNameSpan.textContent = file.name;
  statusDiv.textContent = "ìŒì•… íŒŒì¼ ì¤€ë¹„ ì¤‘...";

  if (!isCameraStarted) {
    statusDiv.textContent = "ì¹´ë©”ë¼ ì‹œì‘ ì¤‘...";
    await camera.start();
    isCameraStarted = true;
  }

  if (file.type === "audio/wav") {
    audioElement.src = URL.createObjectURL(file);
    if (audioElement.paused) {
      await audioElement.play().catch(err => {
        console.warn("ì¬ìƒ ì˜¤ë¥˜:", err);
      });
    }
    statusDiv.textContent = "WAV ìŒì•… ì¬ìƒ ì¤‘...";
  } else if (file.type === "audio/mp3" || file.name.endsWith('.mp3')) {
    worker.postMessage(file);
  } else {
    statusDiv.textContent = "ì§€ì›í•˜ì§€ ì•ŠëŠ” íŒŒì¼ í˜•ì‹ì…ë‹ˆë‹¤.";
  }
});

const hands = new Hands({
  locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`
});
hands.setOptions({
  maxNumHands: 1,
  modelComplexity: 0,
  minDetectionConfidence: 0.7,
  minTrackingConfidence: 0.7
});
hands.onResults(onResults);

const camera = new Camera(videoElement, {
  onFrame: async () => { await hands.send({image: videoElement}); },
  width: 480,
  height: 360
});

function isFingerExtended(landmarks, tip, pip, threshold=0.03) {
  return landmarks[tip].y < landmarks[pip].y - threshold;
}
function isFist(landmarks) {
  return (landmarks[8].y > landmarks[6].y + 0.03 &&
          landmarks[12].y > landmarks[10].y + 0.03 &&
          landmarks[16].y > landmarks[14].y + 0.03 &&
          landmarks[20].y > landmarks[18].y + 0.03);
}
function isOpenPalm(landmarks) {
  return (isFingerExtended(landmarks, 4, 3, 0.05) &&
          isFingerExtended(landmarks, 8, 6) &&
          isFingerExtended(landmarks, 12, 10) &&
          isFingerExtended(landmarks, 16, 14) &&
          isFingerExtended(landmarks, 20, 18));
}
function isThumbOnly(landmarks) {
  return (isFingerExtended(landmarks, 4, 3, 0.05) &&
          !isFingerExtended(landmarks, 8, 6, 0.02) &&
          !isFingerExtended(landmarks, 12, 10, 0.02) &&
          !isFingerExtended(landmarks, 16, 14, 0.02) &&
          !isFingerExtended(landmarks, 20, 18, 0.02));
}
function isPinkyOnly(landmarks) {
  return (!isFingerExtended(landmarks, 4, 3, 0.05) &&
          !isFingerExtended(landmarks, 8, 6, 0.02) &&
          !isFingerExtended(landmarks, 12, 10, 0.02) &&
          !isFingerExtended(landmarks, 16, 14, 0.02) &&
          isFingerExtended(landmarks, 20, 18, 0.05));
}

function onResults(results) {
  canvasCtx.save();
  canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
  canvasCtx.drawImage(results.image, 0, 0, canvasElement.width, canvasElement.height);

  if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
    for (const landmarks of results.multiHandLandmarks) {
      window.drawConnectors(canvasCtx, landmarks, window.HAND_CONNECTIONS, {color: '#00FF00', lineWidth: 3});
      window.drawLandmarks(canvasCtx, landmarks, {color: '#FF0000', lineWidth: 2});

      const now = Date.now();
      if (now - lastGestureTime < 700) continue;

      if (isFist(landmarks)) {
        if (!audioElement.paused) {
          audioElement.pause();
          statusDiv.textContent = "ì œìŠ¤ì²˜: ì£¼ë¨¹ (ìŒì•… ì •ì§€)";
        } else {
          audioElement.play().catch(err => console.warn("ì¬ìƒ ì‹¤íŒ¨:", err));
          statusDiv.textContent = "ì œìŠ¤ì²˜: ì£¼ë¨¹ (ìŒì•… ì¬ìƒ)";
        }
        lastGestureTime = now;
      } else if (isOpenPalm(landmarks)) {
        if (currentSpeed !== 1.5) {
          currentSpeed = 1.5;
          audioElement.playbackRate = currentSpeed;
          audioElement.play().catch(err => console.warn("ì¬ìƒ ì‹¤íŒ¨:", err));
          statusDiv.textContent = "ì œìŠ¤ì²˜: ì†ë°”ë‹¥ (ì†ë„ 1.5x)";
          lastGestureTime = now;
        }
      } else if (isThumbOnly(landmarks)) {
        if (currentSpeed !== 2.0) {
          currentSpeed = 2.0;
          audioElement.playbackRate = currentSpeed;
          audioElement.play().catch(err => console.warn("ì¬ìƒ ì‹¤íŒ¨:", err));
          statusDiv.textContent = "ì œìŠ¤ì²˜: ì—„ì§€ (ì†ë„ 2.0x)";
          lastGestureTime = now;
        }
      } else if (isPinkyOnly(landmarks)) {
        if (currentSpeed !== 1.0) {
          currentSpeed = 1.0;
          audioElement.playbackRate = currentSpeed;
          audioElement.play().catch(err => console.warn("ì¬ìƒ ì‹¤íŒ¨:", err));
          statusDiv.textContent = "ì œìŠ¤ì²˜: ìƒˆë¼ì†ê°€ë½ (ì†ë„ 1.0x)";
          lastGestureTime = now;
        }
      }
    }
  }
  canvasCtx.restore();
}
</script>

</body>
</html>
